<!DOCTYPE html>
<html>
<head>

<title>Painless Flowcharts</title>

<style type="text/css">
body {
  width: 800px;
  margin: 0 auto;
  font-family: Verdana, sans-serif;
}
h1 {
  font-size: 2em;
  margin: .2em;
  float: left;
  text-shadow: #7851A9 0 0 .2em;
}
#menubar {
  margin: 1em;
  float: left;
}
#sidebar {
  clear: left;
  float: left;
  width: 158px;
  height: 478px;
  border: 1px solid gray;
}
#sidebar p {
  margin: 0;
  padding: .8em 1em;
  cursor: pointer;
}
#sidebar #diamond {
  padding: .4em;
}
#sidebar .selected {
  background: #ADF;
}
#paper {
  float: left;
  height: 480px;
  width: 640px;
  background: #FFD;
}
.spotlight svg * {
  opacity: .4;
}
.spotlight .spotlight, .spotlight .spotlight * {
  opacity: .8;
}
</style>

</head>
<body>

<h1>Painless Flowcharts <small>v0.0&alpha;</small></h1>

<p id="menubar">
  <button id="new">New</button>
  <button disabled>Save</button>
</p>

<div id="sidebar">
<p id="rect" class="selected"></p>
<p id="oval"></p>
<p id="diamond"></p>
</div>

<div id="paper"></div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery<%= ".min" unless @dev %>.js"></script>
<script src="raphael<%= "-min" unless @dev %>.js"></script>
<script type="text/javascript">
//by David Allen (github.com/voronoff davidrallen1@gmail.com) and Han Wei (github.com/laughinghan laughinghan@gmail.com)

<% if @dev %>
window.onerror = function() {
  $('html').css('background', 'red');
};
<% end %>

//the Raphael canvas on which all the shapes are drawn
var paper = Raphael('paper', 640, 480), paperDiv = $('#paper');
$('#new').click(function(){paper.clear()});

//Sidebar Shapes:
var rectPaper = Raphael('rect', 120, 60);
rectPaper.rect(.5, .5, 119, 59, 9.5);
rectPaper.text(59.5, 29.5, 'Rect').attr('font-size', 20);

var ovalPaper = Raphael('oval', 120, 60);
ovalPaper.ellipse(60, 30, 59, 29);
ovalPaper.text(59.5, 29.5, 'Oval').attr('font-size', 20);

var diamondPaper = Raphael('diamond', 140, 80);
diamondPaper.path('M 70,1 l -70,39 l 70,39 l 70,-39 l -70,-39');
diamondPaper.text(70, 39.5, 'Diamond').attr('font-size', 20);

//selecting a sidebar shape
var currentShape = $('#sidebar .selected');
$('#sidebar p').click(function() {
  if (currentShape)
    currentShape.removeClass('selected');
  currentShape = $(this).addClass('selected');
});

// ghost image that follows the cursor
var ghost;
function removeGhost() {
	!ghost || ghost.remove();
}
paperDiv.mouseleave(removeGhost);
paperDiv.data('drawghost',true);
paperDiv.data('drawNodes',true);

//behavior of each shape tool
//tool - jQuery object for tool selector
//makeShape(x,y) - callback that draws just the shape and returns it
//makeNode(x,y) - callback that draws the node and returns it
//defaultText - default text for the shape
function defineShapeBehavior(tool,makeShape,makeNode) {
	var onToolSelect = function() {
	 	paperDiv.unbind('click');
		paperDiv.click(drawNode(makeNode));
		paperDiv.unbind('mousemove');
		paperDiv.mousemove(drawGhostNode(makeShape));
	};
	tool.click(onToolSelect);
}

function drawNode(makeNode) {
	return function(e) {
	 	var offset = paperDiv.offset(), x = e.pageX - offset.left, y = e.pageY - offset.top;
		if(paperDiv.data('drawNodes')) {
    		var shape = makeNode(x,y);
			addHandlersForElement(shape);
			paperDiv.data('drawNodes',true); // kludge
		}
	}
}
function addHandlersForElement(shape) {
	function onMouseEnter() {
		paperDiv.data('drawghost',false);
	}
	function onMouseLeave() {
		paperDiv.data('drawghost',true);
	}
	shape.hover(onMouseEnter,onMouseLeave);
}

function drawGhostNode (makeShape) {
	return function(e) {
		var offset = paperDiv.offset(), x = e.pageX - offset.left, y = e.pageY - offset.top;
		removeGhost();
		if (paperDiv.data('drawghost')) {
			ghost = makeShape(x,y).attr({'opacity':.5})
		}
	}
}
function drawGhostEdge(origHook) {
	var ghostEdge;
	return function(e) {
		!ghostEdge || ghostEdge.remove();
		var offset = paperDiv.offset(), x = e.pageX - offset.left, y = e.pageY - offset.top;
		var origX = origHook.attr('cx');
		var origY = origHook.attr('cy');
		alert(origX);
		ghostEdge = paper.path('M' + origX + ',' + origY + ' l ' + x + ',' + y).attr('arrow-end','classic');
	}
}

function startEdge(origHook,ghostNodeFunc) {
	paperDiv.data('drawghost',false);
	paperDiv.data('drawNodes',false);
	return function(e) {
		paperDiv.unbind('mousemove');
		paperDiv.mousemove(drawGhostEdge(origHook));
		paperDiv.click(stopEdge(ghostNodeFunc));
	}
}
function stopEdge(ghostNodeFunc) {
	return function(e) {
		paperDiv.unbind('mousemove');
		paperDiv.mousemove(drawGhostNode(ghostNodeFunc));
		paperDiv.data('drawghost',true);
		paperDiv.data('drawNodes',true);
	}
}

//Makes a function that takes x and y coordinates, draws a flowchard node,
// and returns it.
// makeShape(x,y): callback that draws the shape and returns it
// edgeHookCoordinates: an array of pairs relative coordinates to draw edge hooks
// text: string, default text for the node
function makeNode(makeShape,edgeHookCoordinates,defaultText) {
	return function(x,y) {
		var set = paper.set();
		var shape = makeShape(x,y).attr('fill', '#DFE');
		var hooks = makeHooks(x,y,edgeHookCoordinates,makeShape);
		var text = paper.text(x,y,defaultText).attr('font-size', 20);
		set.push(shape,text);
		hooks.map(function(hook){set.push(hook);})
		return set;
	}
}
function makeHooks(x,y,edgeHookCoordinates,makeShape) {
	return edgeHookCoordinates.map(
		function(coordinatePair) {
			return makeEdgeHook(x+coordinatePair[0],y+coordinatePair[1],makeShape);
		})
}
function makeEdgeHook(x,y,makeShape) {
	var savedClickFunc;
	hook = paper.ellipse(x,y,2,2).attr('fill','#000');
	hook.hover(
		function(){
			paperDiv.data('drawNodes',false);
			this.attr({rx:5,ry:5});
		},
		function(){
			paperDiv.data('drawNodes',true);
			this.attr({rx:2,ry:2});
		});
	hook.click(startEdge(hook,makeShape));
	return hook;
}

// for making rectangles
function makeRectangle(x,y) {
	return paper.rect(x - 59.5, y - 29.5, 119, 59, 9.5);
}
var rectangleEdgeHooks = [[-59.5,0],[0,-29.5],[59.5,0],[0,29.5]];
defineShapeBehavior(
	$('#rect'),
	makeRectangle,
	makeNode(makeRectangle,rectangleEdgeHooks,'Rect')
	);

//for making ovals	
function makeOval(x,y) {
	return paper.ellipse(x, y, 59, 29);
}
var ovalEdgeHooks = rectangleEdgeHooks;
defineShapeBehavior(
	$('#oval'),
	makeOval,
	makeNode(makeOval,ovalEdgeHooks,'Oval')
	);

//for making diamonds
function makeDiamond(x,y) {
	return paper.path("M" + x + "," + (y-40) + " l -70,39 l 70,39 l 70,-39 l -70,-39");
}
var diamondEdgeHooks = [[-70,0],[0,-40],[70,0],[0,40]];
defineShapeBehavior(
	$('#diamond'),
	makeDiamond,
	makeNode(makeDiamond,diamondEdgeHooks,'Diamond')
	);


$('#sidebar .selected').click();
</script>

</body>
</html>
